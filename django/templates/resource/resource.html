{% extends "base.html" %}
{% block body %}
    <!-- /.container -->
	  <div id="listall_show"></div>
  <div id="getarr_show"></div>
	<div style="height:100%; width:100%" class="container">
		<!-- 组别 -->
		<div style="height:100%; width:100%" class="pagination text-center">
			<ul style="height:100%; width:80%">
				<!-- Make dropdown appear above pagination -->
                {% for pg in groups %}
				<li style="height:100%; width:{{ liwidth }}%">
					<a onclick="selectActiveIt(this)" style="height:100%; width:100%">{{ pg.title }}</a>
					<input type="hidden" id="groupid" value="{{ pg.id }}" />
				</li>
                {% endfor %}
			</ul>
		</div>

		<div style="height:10px"></div>
		<div class="row" style="height:80%; width:80%; margin:auto">
			<!-- 系列 -->
			<div style="height:100%; width:100%">
				<div class="btn-group">
					<button id="group-button" type="button" class="btn btn-primary dropdown-toggle" 
						data-toggle="dropdown">类型
						<span class="caret"></span>
					</button>
					<input type="hidden" id="groupid" value="-" />
					<ul id="group-dropdown" class="dropdown-menu" role="menu">
						<li>
							<a onclick="selectActiveIt(this)">全部</a>
							<input type="hidden" value="-" />
						</li>
						<li class="divider"></li>
						{% for pg in groups %}
						<li>
							<a id="groupstitle" onclick="selectActiveIt(this)">{{ pg.title }}</a>
							<input type="hidden" value="{{ pg.id }}" />
						</li>
						{% endfor %}
					</ul>
				</div>
				<div class="btn-group">
					<button id="series-button" type="button" class="btn btn-primary dropdown-toggle" 
						data-toggle="dropdown">系列
						<span class="caret"></span>
					</button>
					<input type="hidden" id="seriesid" value="-" />
					<ul id="series-dropdown" class="dropdown-menu" role="menu">
						<li>
							<a onclick="selectActiveIt(this)">全部</a>
							<input type="hidden" value="-" />
						</li>
						<li class="divider"></li>
						{% for se in series %}
						<li>
							<a id="seriestitle" onclick="selectActiveIt(this)">{{ se.title }}</a>
							<input type="hidden" value="{{ se.id }}" />
						</li>
						{% endfor %}
					</ul>
				</div>
			</div>
			<!-- 节目 -->
			<div class="panel panel-default" style="height:100%; width:100%">
				<ul id="res-list" class="list-group" style="height:100%; width:100%">
				</ul>
				<div class="panel panel-head">
				</div>
				<table id="res-table" class="panel-body table table-striped table-hover">
					<thead id="res-thead">
						<tr>
							<th id="th-title" onclick="sort(this)"><u>名称</u></th>
							<th id="th-group"><u>类型</u></th>
							<th id="th-series"><u>系列</u></th>
							<th id="th-recorder" onclick="sort(this)"><u>播音人</u></th>
							<th id="th-create_time" onclick="sort(this)"><u>上传时间</u></th>
							<th></th>
						</tr>
					</thead>
					<tbody id="res-tbody">
					</tbody>
				</table>
			</div>
		</div>
		
		<!-- 翻页 -->
		<div style="height:100%; width:80%">
			<ul id="page-list" class="pagination-plain" style="float:right">
			</ul>
		</div>
	</div>
<div class="modal fade" id="modifyModal" tabindex="-1" role="dialog" aria-labelledby="modifyModalLabel">
    <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <p>修改节目信息</p>
         </div>
         <div class="modal-body">
			<form id="modify-form" class="form-horizontal" role="form">
                {% csrf_token %}
                <div class="form-group">
                    <label id="modify_status" class="col-sm-6 control-label"></label>
                    <br/>
                    <label id="modify-show" class="col-sm-6 control-label"></label>
                </div>
				<div class="form-group">
					<label for="modify-group" class="col-sm-offset-1 col-sm-2 control-label">组别</label>
					<div class="col-sm-6">
						<input type="text" class="form-control" id="modify-group" placeholder="请输入组别">
					</div>
				</div>
				<div class="form-group">
					<label for="modify-series" class="col-sm-offset-1 col-sm-2 control-label">系列</label>
					<div class="col-sm-6">
						<input type="text" class="form-control" id="modify-series" placeholder="请输入系列">
					</div>
				</div>
				<div class="form-group">
					<label for="modify-title" class="col-sm-offset-1 col-sm-2 control-label">名称</label>
					<div class="col-sm-6">
						<input type="text" class="form-control" id="modify-title" placeholder="请输入名称">
					</div>
				</div>
				<div class="form-group">
					<label for="modify-description" class="col-sm-offset-1 col-sm-2 control-label">描述</label>
					<div class="col-sm-6">
						<input type="text" class="form-control" id="modify-description" placeholder="请输入描述">
					</div>
				</div>
				<div class="form-group">
					<label for="modify-picture0" class="col-sm-offset-1 col-sm-2 control-label">图片</label>
					<div class="col-sm-6">
						<input type="file" class="form-control" id="modify-picture0">
					</div>
				</div>
			</form>
			<div class="col-sm-2" style="float:right">
				<button class="btn btn-xs btn-primary" id="add-picture" onclick="addPicture(this)">+</button>
				<button class="btn btn-xs btn-primary" id="del-picture" onclick="delPicture(this)">-</button>
			</div>
			<br/>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="modify-submit">修改</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
         </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>


    <!-- jQuery (necessary for Flat UI's JavaScript plugins) -->
    <script src="static/dist/js/vendor/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="static/dist/js/flat-ui.min.js"></script>
{% endblock %}
{% block script %}
	<script>
	var pids = new Array();
	var index = 0;
	var pictureIndex=1;
		$(document).ready(function(){
			$.ajax({
			  url:'/resource/listall/',
			  type:"GET",
			  data:{},
				dataType:"json"
			}).done(function(msg){
				pids = msg.pid;
				var count=parseInt(pids.length/10+1);
				document.getElementById("page-list").innerHTML="";
				if (count>1) {
					var linode=document.createElement("li");
					linode.setAttribute("class", "previous");
					var anode=document.createElement("a");
					anode.setAttribute("class", "fui-arrow-left");
					anode.setAttribute("onclick", "prePage(this)");
					linode.appendChild(anode);
					document.getElementById("page-list").appendChild(linode);
					for (var i=1;i<=count;i++) {
						var linode=document.createElement("li");
						var anode=document.createElement("a");
						anode.innerHTML=i;
						anode.setAttribute("onclick", "selectPage(this)");
						linode.appendChild(anode);
						document.getElementById("page-list").appendChild(linode);
					}
					var linode=document.createElement("li");
					linode.setAttribute("class", "previous");
					var anode=document.createElement("a");
					anode.setAttribute("class", "fui-arrow-right");
					anode.setAttribute("onclick", "nextPage(this)");
					linode.appendChild(anode);
					document.getElementById("page-list").appendChild(linode);
				}
				showResource();
			}).fail(function(jqXHR,textStatus){
			});
		});
/*			$('#modify-submit').click(function(){
				$.ajax({
					url:'/resource/modify/',
					type:"POST",
					data:{group:$("#modify-group").val(), series:$("#modify-series").val(), title:$("#modify-title").val(), description:$("#modify-description").val(), picture:$("#modify-picture").val()},
					dataType:"json"
				}).done(function(msg){
				}).fail(function(jqXHR,textStatus){
				});
			});
			$('#delete').click(function(){
				$.ajax({
					url:'resource/delete/',
					type:"POST",
					data:{pid:$("#delete").parent().attr("value")},
				}).done(function(msg){
					location.reload(true);
				}).fail(function(jqXHR，textStatus){
				});
			});*/
		function showResource() {
			var subpids = new Array();
			var len;
			if (pids.length-index > 10) {
				len = 10;
			} else {
				len = pids.length-index;
			}
			for (var i=0;i < len;i++) {
				subpids[i]=pids[i+index];
			}
			$.ajax({
			  url:'/resource/getarr/',
			  type:"POST",
			  data:{'pid':subpids},
				dataType:"json"
			}).done(function(msg){
//				document.getElementById("res-list").innerHTML="";
				document.getElementById("res-tbody").innerHTML="";
			  	for (var i=0;i<len;i++) {
					var tr=document.createElement("tr");
					tr.setAttribute("value", pids[i+index]);
					document.getElementById("res-tbody").appendChild(tr);
					var td_title=document.createElement("td");
					tr.appendChild(td_title);
					var a=document.createElement("a");
					a.innerHTML=msg.program[i].title;
					a.href="/program/"+pids[i+index];
					td_title.appendChild(a);
					var td_group=document.createElement("td");
					td_group.innerHTML=msg.program[i].group;
					tr.appendChild(td_group);
					var td_series=document.createElement("td");
					td_series.innerHTML=msg.program[i].series;
					tr.appendChild(td_series);
					var td_recorder=document.createElement("td");
					td_recorder.innerHTML=msg.program[i].recorder;
					tr.appendChild(td_recorder);
					var td_create_time=document.createElement("td");
					td_create_time.innerHTML=msg.program[i].create_time;
					tr.appendChild(td_create_time);
					var td=document.createElement("td");
					tr.appendChild(td);
					var tddiv=document.createElement("div")
					tddiv.setAttribute("class", "btn-group");
					td.appendChild(tddiv);
					var zanbutton=document.createElement("button");
					zanbutton.setAttribute("class", "btn btn-primary");
					zanbutton.innerHTML="赞";
					tddiv.appendChild(zanbutton);
					var sharebutton=document.createElement("button");
					sharebutton.setAttribute("class", "btn btn-primary");
					sharebutton.innerHTML="分享";
					tddiv.appendChild(sharebutton);
				}
			}).fail(function(jqXHR,textStatus){
			  $('#getarr_show').html('request failed '+ textStatus);
			});
		}
		function activeIt(x) {
			if (!x) return;
			var xClassName = x.className;
			if (xClassName.length == 0) {
				x.className = xClassName;
				return;
			}
			if (xClassName == "active" || xClassName.match(new RegExp("(^|\\s)" + "active" + "(\\s|$)"))) 
				return;
			x.className = xClassName + " " + "active";
		}
		function deactiveIt(x) {
			if (!x) return;
			var xClassName = x.className;
			if (xClassName.length == 0)
				return;
			if (xClassName == "active") {
				x.className = "";
				return;
			}
			if (xClassName.match(new RegExp("(^|\\s)" + "active" + "(\\s|$)"))) 
				x.className = xClassName.replace((new RegExp("(^|\\s)" + "active" + "(\\s|$)")),""); 
		}
		function selectActiveIt(x) {
/*			var y=x.parentNode;
			if (!y) return;
			var yClassName = y.className;
			if (!yClassName.match(new RegExp("(^|\\s)" + "active" + "(\\s|$)")))
				y.className = yClassName + " " + "active";
			var lists = $(x).parent().siblings();
			for (var i=0; i<lists.length; i++) {
				deactiveIt(lists[i]);
			}
*/
			alert(x.innerHTML);
			var groupid;
			var seriesid;
			if (x.id=="groupstitle") {
				alert(x.innerHTML);
				groupid=$(x).next().attr("value");
				seriesid="-";
				if (x.innerHTML=="全部") {
					document.getElementById("group-button").innerHTML="类型<span class='caret'></span>";
					document.getElementById("groupid").setAttribute("value", "-");
				} else {
					document.getElementById("group-button").innerHTML=x.innerHTML+"<span class='caret'></span>";
					document.getElementById("groupid").setAttribute("value", groupid);
				}
			} else if (x.id=="seriestitle") {
				groupid=$("#groupid").attr("value");
				seriesid=$(x).next().attr("value");
				if (x.innerHTML=="全部") {
					document.getElementById("series-button").innerHTML="类型<span class='caret'></span>";
					document.getElementById("seriesid").setAttribute("value", "-");
				} else {
					document.getElementById("series-button").innerHTML=x.innerHTML+"<span class='caret'></span>";
					document.getElementById("seriesid").setAttribute("value", seriesid);
				}
			}
			$.ajax({
			  url:'/resource/filter/',
			  type:"GET",
			  data:{'groupid':groupid, 'seriesid':seriesid},
				dataType:"json"
			}).done(function(msg){
				pids = msg.pid;
				var count=parseInt(pids.length/10+1);
				document.getElementById("page-list").innerHTML="";
				if (count>1) {
					var linode=document.createElement("li");
					linode.setAttribute("class", "previous");
					var anode=document.createElement("a");
					anode.setAttribute("class", "fui-arrow-left");
					anode.setAttribute("onclick", "prePage(this)");
					linode.appendChild(anode);
					document.getElementById("page-list").appendChild(linode);
					for (var i=1;i<=count;i++) {
						var linode=document.createElement("li");
						var anode=document.createElement("a");
						anode.innerHTML=i;
						anode.setAttribute("onclick", "selectPage(this)");
						linode.appendChild(anode);
						document.getElementById("page-list").appendChild(linode);
					}
					var linode=document.createElement("li");
					linode.setAttribute("class", "previous");
					var anode=document.createElement("a");
					anode.setAttribute("class", "fui-arrow-right");
					anode.setAttribute("onclick", "nextPage(this)");
					linode.appendChild(anode);
					document.getElementById("page-list").appendChild(linode);
				}
				showResource();
			}).fail(function(jqXHR,textStatus){
			});
		}
		function nextPage(x) {
			if (index+10<pids.length) {
				index=index+10;
				showResource();
			}
		}
		function prePage(x) {
			if (index-10>=0) {
				index=index-10;
				showResource();
			}
		}
		function selectPage(x) {
			index=(x.innerHTML-1)*10;
			showResource();
		}
		function addPicture(x) {
			var fdiv=document.createElement("div");
			fdiv.setAttribute("class", "form-group");
			fdiv.setAttribute("id", "adddiv"+pictureIndex);
			document.getElementById("modify-form").appendChild(fdiv);
			var plabel=document.createElement("label");
			plabel.setAttribute("for", "modify-picture"+pictureIndex);
			plabel.setAttribute("class", "col-sm-offset-1 col-sm-2 control-label");
			plabel.innerHTML="图片";
			fdiv.appendChild(plabel);
			var pdiv=document.createElement("div");
			pdiv.setAttribute("class", "col-sm-6");
			fdiv.appendChild(pdiv);
			var pinput=document.createElement("input");
			pinput.setAttribute("type", "file");
			pinput.setAttribute("class", "form-control");
			pinput.setAttribute("id", "modify-picture"+pictureIndex);
			pdiv.appendChild(pinput);
			pictureIndex=pictureIndex+1;
		}
		function delPicture(x) {
			if (pictureIndex>1) {
				pictureIndex=pictureIndex-1;
				var parent=document.getElementById("modify-form");
				var node=document.getElementById("adddiv"+pictureIndex);
				parent.removeChild(node);
			}
		}
		function sort(x) {
			var xid=$(x).attr("id");
			var sortarg=xid.replace((new RegExp("th")), "");
			var newid;
			if (xid.match(new RegExp("th-"))) {
				newid=xid.replace((new RegExp("th-")), "th");
			} else {
				newid=xid.replace((new RegExp("th")), "th-");
			}
			x.setAttribute("id", newid);
			alert(sortarg);
			$.ajax({
				url:'/resource/sort/',
				type:"GET",
				data:{'pid':pids, 'sort':sortarg},
				dataType:"json"
			}).done(function(msg) {
				pids = msg.pid;
				alert(pids);
				showResource();
			}).fail(function(jqXHR, textStatus) {
				alert(0);
			});
			alert(1);
		}
		function filter(x) {
		}
	</script>

{% endblock %}
